name: Deploy - Production Deployment

# Trigger only on pushes to main (after CI passes)
on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

# Ensure only one deployment runs at a time
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # ============================================
  # Job 1: Deploy Web App to Firebase Hosting
  # ============================================
  deploy-web:
    name: Deploy Web to Firebase Hosting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm build:packages

      - name: Build web application
        run: pnpm --filter web build
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
          channelId: live
          target: web

      - name: Deployment Summary
        run: |
          echo "‚úÖ Web app deployed to Firebase Hosting"
          echo "üåê URL: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app"

  # ============================================
  # Job 2: Deploy Firebase Functions
  # ============================================
  deploy-functions:
    name: Deploy Firebase Functions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build functions
        run: pnpm --filter functions build

      - name: Deploy to Firebase Functions
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only functions
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Deployment Summary
        run: echo "‚úÖ Firebase Functions deployed"

  # ============================================
  # Job 3: Build Android App with EAS
  # ============================================
  build-android:
    name: Build Android App (EAS)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm build:packages

      - name: Build Android app with EAS
        working-directory: apps/mobile
        run: |
          eas build \
            --platform android \
            --profile production \
            --non-interactive \
            --no-wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Build Summary
        run: |
          echo "‚úÖ Android build submitted to EAS"
          echo "üì± Check build status: https://expo.dev/accounts/[your-account]/projects/flipfeeds/builds"

  # ============================================
  # Job 4: Build iOS App with EAS (macOS runner)
  # ============================================
  build-ios:
    name: Build iOS App (EAS)
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch' # Only run manually for iOS

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm build:packages

      - name: Build iOS app with EAS
        working-directory: apps/mobile
        run: |
          eas build \
            --platform ios \
            --profile production \
            --non-interactive \
            --no-wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Build Summary
        run: |
          echo "‚úÖ iOS build submitted to EAS"
          echo "üì± Check build status: https://expo.dev/accounts/[your-account]/projects/flipfeeds/builds"

  # ============================================
  # Summary Job
  # ============================================
  deployment-success:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [deploy-web, deploy-functions, build-android]
    if: success()

    steps:
      - name: Success Notification
        run: |
          echo "üéâ Deployment completed successfully!"
          echo ""
          echo "Deployed:"
          echo "  ‚úÖ Web App (Firebase Hosting)"
          echo "  ‚úÖ Firebase Functions"
          echo "  ‚úÖ Android App (EAS Build)"
          echo ""
          echo "Next steps:"
          echo "  - Check EAS builds: https://expo.dev"
          echo "  - Test web app: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app"
          echo "  - Submit to Play Store when EAS build completes"
