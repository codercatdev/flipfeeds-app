rules_version = '2';

// Firebase Storage Security Rules
service firebase.storage {
    match /b/{bucket}/o {

        // Profile images structure:
        // profile-images/{userId}/generated/{imageId} - AI-generated images (temporary)
        // profile-images/{userId}/selected/{imageId} - User's selected profile image
        // profile-images/{userId}/uploaded/{imageId} - User-uploaded images
        // profile-images/{userId}/processed/{imageId} - Processed/optimized images
        
        match /profile-images/{userId}/{imageType}/{imageId} {
            // Allow public read for all profile images
            allow read: if true;

            // Allow write only if:
            // 1. User is authenticated
            // 2. User is writing their own profile image (userId matches their uid)
            // 3. File is an image (content type check)
            // 4. File size is less than 5MB
            // 5. imageType is one of: generated, selected, uploaded, processed
            allow write: if request.auth != null 
                && request.auth.uid == userId
                && request.resource.contentType.matches('image/.*')
                && request.resource.size < 5 * 1024 * 1024
                && (imageType == 'generated' || imageType == 'selected' || imageType == 'uploaded' || imageType == 'processed');
            
            // Allow delete only for own images
            allow delete: if request.auth != null 
                && request.auth.uid == userId;
        }

        // Legacy profile-pictures path (keep for backward compatibility)
        match /profile-pictures/{userId} {
            allow read: if true;
            allow write: if request.auth != null 
                && request.auth.uid == userId
                && request.resource.contentType.matches('image/.*')
                && request.resource.size < 5 * 1024 * 1024;
        }

        // Generated videos structure:
        // generated-videos/{userId}/{videoId}.mp4 - AI-generated videos
        match /generated-videos/{userId}/{videoId} {
            // Allow public read for all generated videos
            allow read: if true;

            // Allow write only from Cloud Functions (service account)
            // User-facing clients should NOT write directly to this path
            // Videos are uploaded via the uploadGeneratedVideoTool
            allow write: if false;
            
            // Allow delete only for video owner
            allow delete: if request.auth != null 
                && request.auth.uid == userId;
        }

        // Deny all other access by default
        match /{allPaths=**} {
            allow read, write: if false;
        }
    }
}
