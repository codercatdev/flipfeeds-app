FlipFeeds: Core Firestore Data SchemaThis schema is designed for a multi-tenant system where "Feeds" are the tenants. All paths should be constants in your code.We will use a version field (e.g., v1) on top-level collections to make future schema migrations easier.1. Collection: usersStores public-facing user profile data and private user-specific info.Path: v1/users/{userId}{userId} will be the Firebase Auth UID.Document ({userId}):{
  "uid": "fbas_auth_uid",
  "email": "user@example.com", // From Auth, can be private
  "displayName": "UserName",
  "photoURL": "[https://path.to/avatar.png](https://path.to/avatar.png)", // User's main avatar
  "username": "username_handle", // Unique, public-facing @handle
  "bio": "About me...",
  "createdAt": "FirebaseServerTimestamp",
  "updatedAt": "FirebaseServerTimestamp",
  "settings": {
    "theme": "dark",
    "notifications": {
      "pushEnabled": true,
      "emailEnabled": false
    }
  },
  "fcmTokens": ["token1", "token2"] // For push notifications
}

## 2. Collection: feeds

Stores all Feed data. This is the central collection.

**Path:** `v1/feeds/{feedId}`

`{feedId}` will be a unique ID generated by Firestore.

**Document ({feedId}):**

```json
{
  "name": "My Cool Next.js Feed",
  "description": "A place to share videos about Next.js and Firebase.",
  "logoURL": "[https://path.to/feed-logo.png](https://path.to/feed-logo.png)", // The orange logo
  "bannerURL": "[https://path.to/feed-banner.png](https://path.to/feed-banner.png)",
  "visibility": "public" | "private", // 'public' = discoverable, 'private' = invite-only
  "ownerId": "userId_of_owner", // Ref to v1/users/{userId}
  "stats": {
    "memberCount": 150,
    "flipCount": 45
  },
  "createdAt": "FirebaseServerTimestamp",
  "updatedAt": "FirebaseServerTimestamp",
  "tags": ["nextjs", "firebase", "react", "genkit"] // For discoverability
}
3. Sub-Collection: feedMembersTracks the relationship between users and feeds. This is critical for security rules.Path: v1/feeds/{feedId}/members/{userId}This structure allows us to easily check if a user is in a feed.Document ({userId}):{
  "userId": "fbas_auth_uid",
  "role": "admin" | "moderator" | "member",
  "joinedAt": "FirebaseServerTimestamp",
  "displayName": "UserName", // Denormalized for easy display
  "photoURL": "[https://path.to/avatar.png](https://path.to/avatar.png)" // Denormalized
}

Note: We also need a reverse lookup.

## 4. Sub-Collection: userFeeds

A reverse-lookup collection to quickly find all feeds a user is in.

**Path:** `v1/users/{userId}/feeds/{feedId}`

This allows a user to see their list of "My Feeds" without a complex query.

**Document ({feedId}):**

```json
{
  "feedId": "feedId_from_feeds_collection",
  "joinedAt": "FirebaseServerTimestamp",
  "role": "admin" | "moderator" | "member",
  "name": "My Cool Next.js Feed", // Denormalized
  "logoURL": "[https://path.to/feed-logo.png](https://path.to/feed-logo.png)" // Denormalized
}
```

## 4a. Personal Feeds: Every User's Private Space

Every user automatically gets a **Personal Feed** upon account creation.

**Path:** `v1/feeds/personal_{userId}`

This is a special feed that:
- Only the user can access (no other members)
- Never appears in discovery or public feed lists
- Provides full AI features (summaries, search, etc.)
- Acts as private storage and draft workspace

**Document (personal_{userId}):**

```json
{
  "feedId": "personal_{userId}",
  "name": "Personal Feed",
  "description": "Your private space",
  "type": "personal", // Special type to distinguish from regular feeds
  "visibility": "personal", // Never "public" or "private" - it's "personal"
  "ownerId": "userId",
  "stats": {
    "memberCount": 1, // Always 1 (the owner)
    "flipCount": 0
  },
  "createdAt": "FirebaseServerTimestamp",
  "updatedAt": "FirebaseServerTimestamp"
}
```

**User Reference:** `v1/users/{userId}/personalFeed`

```json
{
  "feedId": "personal_{userId}",
  "createdAt": "FirebaseServerTimestamp"
}
```

**Security:** Personal Feeds have special security rules - only the owner can read/write.

**User Language:** "Did you see the flip I sent to you in your feed?" could refer to:
- A flip in a shared Feed
- A flip sent to someone's Personal Feed (future DM feature)

## 5. Collection: flips

Stores all flips (primarily videos) for all feeds. We use a root-level collection and query by feedId for scalability.

**Path:** `v1/flips/{flipId}`

**Document ({flipId}):**

```json
{
  "feedId": "feedId_of_parent", // **Indexed field for querying**
  "authorId": "userId_of_author",
  "authorInfo": { // Denormalized for display
    "displayName": "UserName",
    "photoURL": "[https://path.to/avatar.png](https://path.to/avatar.png)"
  },
  "type": "video" | "text" | "image",
  "title": "My First Video Flip!",
  "textContent": "Check this out...", // For text-only flips
  "createdAt": "FirebaseServerTimestamp",
  "updatedAt": "FirebaseServerTimestamp",
  "media": {
    "video": {
      "storagePath": "videos/{feedId}/{flipId}/video.mp4",
      "url": "[https://firebasestorage.googleapis.com/](https://firebasestorage.googleapis.com/)...", // Public URL
      "durationMs": 120000
    },
    "thumbnail": {
      "storagePath": "videos/{feedId}/{flipId}/thumb.jpg",
      "url": "[https://firebasestorage.googleapis.com/](https://firebasestorage.googleapis.com/)..."
    }
  },
  "aiData": {
    "summary": "This video shows how to use Genkit with Firebase.",
    "isModerated": true,
    "moderationFlags": [],
    "tags": ["genkit", "firebase"]
  },
  "stats": {
    "likeCount": 10,
    "commentCount": 5
  }
}

## 6. Sub-Collection: comments

Comments for a specific flip.

**Path:** `v1/flips/{flipId}/comments/{commentId}`

**Document ({commentId}):**

```json
{
  "flipId": "flipId_of_parent",
  "authorId": "userId_of_author",
  "authorInfo": { // Denormalized
    "displayName": "UserName",
    "photoURL": "[https://path.to/avatar.png](https://path.to/avatar.png)"
  },
  "textContent": "Great video!",
  "createdAt": "FirebaseServerTimestamp",
  "updatedAt": "FirebaseServerTimestamp"
}
```

---

# FlipFeeds: Core Firebase Security Rules

This is a foundational firestore.rules file. It's critical for securing your multi-tenant data.

This is a starting point and MUST be tested thoroughly with the Firebase Emulator Suite.

```javascript
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is the owner of a document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Get user's role in a specific feed
    function getRole(feedId) {
      return get(/databases/$(database)/documents/v1/feeds/$(feedId)/members/$(request.auth.uid)).data.role;
    }

    // Check if user is a member of a feed
    function isMember(feedId) {
      return exists(/databases/$(database)/documents/v1/feeds/$(feedId)/members/$(request.auth.uid));
    }

    // Check if a feed is public
    function isPublicFeed(feedId) {
      return get(/databases/$(database)/documents/v1/feeds/$(feedId)).data.visibility == 'public';
    }

    // Check if a feed is a personal feed
    function isPersonalFeed(feedId) {
      return feedId.matches('personal_.*');
    }

    // Check if user owns a personal feed
    function ownsPersonalFeed(feedId) {
      return feedId == 'personal_' + request.auth.uid;
    }

    // --- /users Collection ---
    match /v1/users/{userId} {
      // READ: Any authenticated user can read public profile data
      allow get: if isAuthenticated();

      // UPDATE: Only the user themselves can update their profile
      allow update: if isOwner(userId);
      
      // CREATE: Handled by your auth/genkit flow
      allow create: if isOwner(userId);

      // --- /userFeeds Sub-collection ---
      match /feeds/{feedId} {
        // READ/LIST: Only the user can see their own list of feeds
        allow read: if isOwner(userId);
        
        // WRITE: Only Genkit flows (backend) should write this
        allow write: if false; 
      }

      // --- /personalFeed Document ---
      match /personalFeed {
        // READ: Only the user can read their own personal feed reference
        allow read: if isOwner(userId);
        
        // WRITE: Only backend (on user creation)
        allow write: if false;
      }
    }

    // --- /feeds Collection ---
    match /v1/feeds/{feedId} {
      // Personal Feeds: Only owner can read/write
      allow get: if isPersonalFeed(feedId) && ownsPersonalFeed(feedId);
      
      // Regular Feeds:
      // - Any authenticated user can read a 'public' feed's data
      // - Only members can read a 'private' feed's data
      allow get: if !isPersonalFeed(feedId) && isAuthenticated() && (isPublicFeed(feedId) || isMember(feedId));
      
      // LIST: (For Discovery)
      // Only allow listing public feeds (never personal feeds)
      allow list: if isAuthenticated() && request.query.where.visibility == 'public';

      // UPDATE: Only admins of the feed
      allow update: if isAuthenticated() && getRole(feedId) == 'admin';
      
      // CREATE: Handled by your genkit flow (backend), not by clients
      allow create: if false;
      
      // DELETE: Only admins
      allow delete: if isAuthenticated() && getRole(feedId) == 'admin';

      // --- /members Sub-collection ---
      match /members/{userId} {
        // READ/LIST: Only other members of the feed
        allow read: if isAuthenticated() && isMember(feedId);
        
        // CREATE: (Joining)
        // - Public feeds: Any auth'd user (handled by joinFeedFlow)
        // - Private feeds: Only admins/mods (inviting)
        // We'll deny client-side writes and force this through a flow
        allow write: if false;
        
        // UPDATE: (Change role) Only admins
        // DELETE: (Leave/Kick) User can leave, or admin can kick
        allow update: if isAuthenticated() && getRole(feedId) == 'admin';
        allow delete: if isAuthenticated() && (isOwner(userId) || getRole(feedId) == 'admin');
      }
    }
    
    // --- /flips Collection ---
    match /v1/flips/{flipId} {
      // Get the feedId from the flip document
      let feedId = resource.data.feedId;

      // READ: 
      // - If the feed is public, any auth'd user can read
      // - If the feed is private, only members can read
      allow get: if isAuthenticated() && (isPublicFeed(feedId) || isMember(feedId));
      
      // LIST:
      // Client can only list flips *for a specific feed*
      // And they must be a member or the feed must be public
      allow list: if isAuthenticated()
                    && request.query.where.feedId == feedId
                    && (isPublicFeed(feedId) || isMember(feedId));
                    
      // CREATE: Only members of the feed
      allow create: if isAuthenticated() && isMember(feedId);

      // UPDATE: Only the flip author
      allow update: if isAuthenticated() && isOwner(resource.data.authorId);
      
      // DELETE: Flip author or feed admin/mod
      allow delete: if isAuthenticated() && (isOwner(resource.data.authorId) || getRole(feedId) == 'admin' || getRole(feedId) == 'moderator');

      // --- /comments Sub-collection ---
      match /comments/{commentId} {
        // READ: Same rules as the parent flip
        allow read: if isAuthenticated() && (isPublicFeed(feedId) || isMember(feedId));
        
        // CREATE: Only members of the feed
        allow create: if isAuthenticated() && isMember(feedId);
        
        // UPDATE: Only the comment author
        allow update: if isAuthenticated() && isOwner(resource.data.authorId);
        
        // DELETE: Comment author or feed admin/mod
        allow delete: if isAuthenticated() && (isOwner(resource.data.authorId) || getRole(feedId) == 'admin' || getRole(feedId) == 'moderator');
      }
    }
  }
}
